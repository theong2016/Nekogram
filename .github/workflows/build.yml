name: è²è²ç”µæŠ¥ - VMess å¢å¼ºç‰ˆ

on:
  workflow_dispatch:
  push:
    branches: 
      - codex/add-built-in-vmess-agent-toggle
    paths-ignore:
      - '**.md'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: è®¾ç½® JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: è®¾ç½® Android SDK
      uses: android-actions/setup-android@v3

    - name: å®‰è£… NDK
      run: |
        echo "y" | sudo ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --install "ndk;26.1.10909125"
        echo "ANDROID_NDK_HOME=${ANDROID_HOME}/ndk/26.1.10909125" >> $GITHUB_ENV

    - name: ä¸ªæ€§åŒ– - åº”ç”¨åç§°
      run: |
        # ä¿®æ”¹åº”ç”¨åç§°ä¸º"è²è²ç”µæŠ¥"
        sed -i 's|<string name="AppName">Nekogram</string>|<string name="AppName">è²è²ç”µæŠ¥</string>|g' TMessagesProj/src/main/res/values*/strings.xml
        sed -i 's|<string name="AppNameBeta">Nekogram Beta</string>|<string name="AppNameBeta">è²è²ç”µæŠ¥ VMess</string>|g' TMessagesProj/src/main/res/values*/strings.xml

    - name: ä¸‹è½½å¹¶æ›¿æ¢äºŒæ¬¡å…ƒå›¾æ ‡
      run: |
        curl -L "https://www.loliapi.com/acg" -o /tmp/icon.jpg
        sudo apt-get update && sudo apt-get install -y imagemagick
        
        convert /tmp/icon.jpg -resize 192x192^ -gravity center -extent 192x192 TMessagesProj/src/main/res/mipmap-xxxhdpi/ic_launcher.png
        convert /tmp/icon.jpg -resize 144x144^ -gravity center -extent 144x144 TMessagesProj/src/main/res/mipmap-xxhdpi/ic_launcher.png
        convert /tmp/icon.jpg -resize 96x96^ -gravity center -extent 96x96 TMessagesProj/src/main/res/mipmap-xhdpi/ic_launcher.png
        convert /tmp/icon.jpg -resize 72x72^ -gravity center -extent 72x72 TMessagesProj/src/main/res/mipmap-hdpi/ic_launcher.png
        convert /tmp/icon.jpg -resize 48x48^ -gravity center -extent 48x48 TMessagesProj/src/main/res/mipmap-mdpi/ic_launcher.png

    - name: ä¸‹è½½åŠ é€Ÿè¡¥ä¸
      run: |
        DOWNLOAD_FILE="TMessagesProj/src/main/java/org/telegram/messenger/FileLoadOperation.java"
        if [ -f "$DOWNLOAD_FILE" ]; then
          sed -i 's/private static final int MAX_DOWNLOAD_REQUESTS = 2/private static final int MAX_DOWNLOAD_REQUESTS = 8/g' "$DOWNLOAD_FILE" || true
          sed -i 's/private static final int MAX_DOWNLOAD_REQUESTS_BIG = 4/private static final int MAX_DOWNLOAD_REQUESTS_BIG = 16/g' "$DOWNLOAD_FILE" || true
          echo "âœ… ä¸‹è½½åŠ é€Ÿå·²å¯ç”¨ (8-16çº¿ç¨‹)"
        fi

    - name: ç¼–è¯‘ APK
      run: |
        chmod +x gradlew
        ./gradlew assembleAfatRelease --stacktrace
        
    - name: ç­¾å APK
      run: |
        keytool -genkey -v -keystore release.jks -keyalg RSA -keysize 2048 -validity 10000 \
          -storepass lianlian -keypass lianlian -alias lianlian \
          -dname "CN=LianLian, OU=Telegram, O=LianLian, L=City, S=State, C=CN"
        
        APK_PATH=$(find TMessagesProj/build/outputs/apk -name "*.apk" | head -1)
        if [ -f "$APK_PATH" ]; then
          ${ANDROID_HOME}/build-tools/34.0.0/zipalign -v -p 4 "$APK_PATH" aligned.apk
          ${ANDROID_HOME}/build-tools/34.0.0/apksigner sign --ks release.jks \
            --ks-pass pass:lianlian --key-pass pass:lianlian --out lianlian-vmess.apk aligned.apk
          echo "âœ… APK ç­¾åå®Œæˆ"
        fi

    - name: ä¸Šä¼  APK
      uses: actions/upload-artifact@v4
      with:
        name: è²è²ç”µæŠ¥-VMessç‰ˆ
        path: lianlian-vmess.apk
        retention-days: 30

    - name: åˆ›å»º Release
    
uses: softprops/action-gh-release@v1      with:
        tag_name: vmess-v${{ github.run_number }}
        name: è²è²ç”µæŠ¥ VMess ç‰ˆ #${{ github.run_number }}
        body: |
          ğŸ‰ è²è²ç”µæŠ¥ - å†…ç½® VMess ä»£ç†ç‰ˆ
          
          **ç‰¹æ€§ï¼š**
          - âœ… å†…ç½® VMess ä»£ç†ç®¡ç†ï¼ˆæ·»åŠ /ç¼–è¾‘/åˆ é™¤/åˆ‡æ¢ï¼‰
          - âœ… ä¸‹è½½åŠ é€Ÿï¼ˆ8-16 çº¿ç¨‹å¹¶è¡Œï¼‰
          - âœ… äºŒæ¬¡å…ƒèŒå¦¹éšæœºå›¾æ ‡
          - âœ… åŸºäº Nekogram æœ€æ–°ä»£ç 
          
          **ä½¿ç”¨æ–¹æ³•ï¼š**
          å®‰è£…åè¿›å…¥ è®¾ç½® â†’ æ•°æ®ä¸å­˜å‚¨ â†’ VMess ä»£ç†
          
          **ç¼–è¯‘æ—¶é—´ï¼š** ${{ github.event.head_commit.timestamp }}
        files: lianlian-vmess.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
