name: 莲莲电报编译

on:
  push:
    branches:
      - master
      - codex/add-built-in-vmess-agent-toggle
    paths-ignore:
      - '**.md'
  workflow_dispatch:

jobs:
  build:
    name: 编译莲莲电报
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 0

      - name: 设置 JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: 设置 Android SDK
        uses: android-actions/setup-android@v3

      - name: 设置 Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: 个性化配置
        run: |
          sed -i 's|<string name="AppName">Nekogram</string>|<string name="AppName">莲莲电报</string>|g' TMessagesProj/src/main/res/values*/strings.xml
          
          curl -L "https://www.loliapi.com/acg" -o /tmp/icon.jpg
          sudo apt-get update && sudo apt-get install -y imagemagick
          
          convert /tmp/icon.jpg -resize 192x192^ -gravity center -extent 192x192 TMessagesProj/src/main/res/mipmap-xxxhdpi/ic_launcher.png
          convert /tmp/icon.jpg -resize 144x144^ -gravity center -extent 144x144 TMessagesProj/src/main/res/mipmap-xxhdpi/ic_launcher.png
          convert /tmp/icon.jpg -resize 96x96^ -gravity center -extent 96x96 TMessagesProj/src/main/res/mipmap-xhdpi/ic_launcher.png
          convert /tmp/icon.jpg -resize 72x72^ -gravity center -extent 72x72 TMessagesProj/src/main/res/mipmap-hdpi/ic_launcher.png
          convert /tmp/icon.jpg -resize 48x48^ -gravity center -extent 48x48 TMessagesProj/src/main/res/mipmap-mdpi/ic_launcher.png

      - name: 列出可用任务
        run: |
          chmod +x ./gradlew
          ./gradlew tasks --all | grep -i "assemble" || true

      - name: 编译 APK
        run: |
          # 尝试多个可能的编译任务
          ./gradlew assembleRelease || \
          ./gradlew assembleMiniRelease || \
          ./gradlew assembleFullRelease || \
          ./gradlew TMessagesProj:assembleRelease

      - name: 查找并上传 APK
        uses: actions/upload-artifact@v4
        with:
          name: 莲莲电报-APK
          path: |
            TMessagesProj/build/outputs/apk/**/*.apk
            */build/outputs/apk/**/*.apk
          if-no-files-found: error
      - name: 验证并修复 XML 文件
        run: |
          # 检查 XML 格式
          xmllint --noout TMessagesProj/src/main/res/values/strings.xml || {
            echo "❌ strings.xml 格式错误，尝试自动修复..."
            
            # 备份原文件
            cp TMessagesProj/src/main/res/values/strings.xml /tmp/strings_backup.xml
            
            # 使用 xmllint 格式化（自动修复一些简单问题）
            xmllint --format TMessagesProj/src/main/res/values/strings.xml > /tmp/strings_fixed.xml || {
              echo "⚠️ 自动修复失败，显示错误位置："
              xmllint TMessagesProj/src/main/res/values/strings.xml 2>&1 | head -20
              exit 1
            }
            
            # 替换文件
            mv /tmp/strings_fixed.xml TMessagesProj/src/main/res/values/strings.xml
            echo "✅ XML 已自动修复"
          }
