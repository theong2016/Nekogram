name: 莲莲电报编译
on:
  push:
    branches:
      - master
      - codex/add-built-in-vmess-agent-toggle
    paths-ignore:
      - '**.md'
  workflow_dispatch:
jobs:
  build:
    name: 编译莲莲电报
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 0

      - name: 设置 JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: 设置 Android SDK
        uses: android-actions/setup-android@v3

      - name: 设置 Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: 修复 strings.xml
        run: |
          cd TMessagesProj/src/main/res/values
          sed -i '/<\/resources>/d' strings.xml
          echo "</resources>" >> strings.xml

      - name: 配置 Gradle 内存
        run: |
          cat >> gradle.properties << EOF
          org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m
          org.gradle.daemon=true
          org.gradle.parallel=true
          EOF

      - name: 创建 Google Services 配置
        run: |
          cat > TMessagesProj_App/google-services.json << 'ENDOFJSON'
          {
            "project_info": {
              "project_number": "123456789000",
              "firebase_url": "https://lianlian-telegram.firebaseio.com",
              "project_id": "lianlian-telegram",
              "storage_bucket": "lianlian-telegram.appspot.com"
            },
            "client": [
              {
                "client_info": {
                  "mobilesdk_app_id": "1:123456789000:android:1234567890abcdef",
                  "android_client_info": {
                    "package_name": "nekox.messenger"
                  }
                },
                "oauth_client": [
                  {
                    "client_id": "123456789000-abcdefghijklmnopqrstuvwxyz123456.apps.googleusercontent.com",
                    "client_type": 3
                  }
                ],
                "api_key": [
                  {
                    "current_key": "AIzaSyDummyKeyForCompilationOnlyNotForProduction"
                  }
                ],
                "services": {
                  "appinvite_service": {
                    "other_platform_oauth_client": [
                      {
                        "client_id": "123456789000-abcdefghijklmnopqrstuvwxyz123456.apps.googleusercontent.com",
                        "client_type": 3
                      }
                    ]
                  }
                }
              }
            ],
            "configuration_version": "1"
          }
          ENDOFJSON

      - name: 个性化配置
        run: |
          sed -i 's|<string name="AppName">Nekogram</string>|<string name="AppName">莲莲电报</string>|g' TMessagesProj/src/main/res/values*/strings.xml
          curl -L "https://www.loliapi.com/acg" -o /tmp/icon.jpg
          sudo apt-get update && sudo apt-get install -y imagemagick
          convert /tmp/icon.jpg -resize 192x192^ -gravity center -extent 192x192 TMessagesProj/src/main/res/mipmap-xxxhdpi/ic_launcher.png
          convert /tmp/icon.jpg -resize 144x144^ -gravity center -extent 144x144 TMessagesProj/src/main/res/mipmap-xxhdpi/ic_launcher.png
          convert /tmp/icon.jpg -resize 96x96^ -gravity center -extent 96x96 TMessagesProj/src/main/res/mipmap-xhdpi/ic_launcher.png
          convert /tmp/icon.jpg -resize 72x72^ -gravity center -extent 72x72 TMessagesProj/src/main/res/mipmap-hdpi/ic_launcher.png
          convert /tmp/icon.jpg -resize 48x48^ -gravity center -extent 48x48 TMessagesProj/src/main/res/mipmap-mdpi/ic_launcher.png
                - name: 编译 APK
        run: |
          chmod +x ./gradlew
          ./gradlew assembleRelease --no-daemon --max-workers=2

      - name: 上传 APK
        uses: actions/upload-artifact@v4
        with:
          name: 莲莲电报-APK
          path: |
            TMessagesProj/build/outputs/apk/**/*.apk
            TMessagesProj_App/build/outputs/apk/**/*.apk
